<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Calificaciones</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
</head>

<body class="d-flex flex-column min-vh-100">
    <div id="app" class="flex-grow-1 d-flex flex-column">
        
        <!-- HEADER -->
        <header class="bg-danger text-white text-center py-3">
            <h1 class="h3"><i class="bi bi-person-circle me-2"></i>Bienvenido al Panel del Estudiante</h1>
        </header>

        <!-- NAV -->
        <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
            <div class="container">
                <a class="navbar-brand" href="#">Menú</a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <div class="collapse navbar-collapse" id="navbarNav">
                    <ul class="navbar-nav ms-auto">
                        <li class="nav-item"><a class="nav-link" href="panel.html">Panel</a></li>
                        <li class="nav-item"><a class="nav-link" href="asignaturas.html">Asignaturas</a></li>
                        <li class="nav-item"><a class="nav-link" href="asignaciones.html">Asignaciones</a></li>
                        <li class="nav-item"><a class="nav-link active" href="calificaciones.html">Calificaciones</a></li>
                        <li class="nav-item"><a class="nav-link" href="index.html">Cerrar sesión</a></li>
                    </ul>
                </div>
            </div>
        </nav>

        <!-- Loading State -->
        <div v-if="loading" class="container py-4 text-center">
            <div class="spinner-border text-danger" role="status">
                <span class="visually-hidden">Cargando...</span>
            </div>
            <p class="mt-2">Cargando información académica...</p>
        </div>

        <!-- Error State -->
        <div v-else-if="error" class="container py-4">
            <div class="alert alert-danger" role="alert">
                <i class="bi bi-exclamation-triangle me-2"></i>{{ error }}
            </div>
        </div>

        <!-- MAIN -->
        <main v-else class="container my-4 flex-grow-1">
            <!-- Información del estudiante -->
            <div class="row mb-4">
                <div class="col-md-8">
                    <h2 class="text-danger">
                        <i class="bi bi-clipboard-data me-2"></i>
                        Panel Académico - Grado {{ grado }}
                    </h2>
                    <p class="text-muted">Estudiante: <strong>{{ nombreUsuario }}</strong></p>
                </div>
                <div class="col-md-4">
                    <!-- Promedio general -->
                    <div class="card text-center border-0 shadow-sm">
                        <div class="card-body">
                            <h5 class="card-title">Promedio General</h5>
                            <h2 :class="getPromedioClass(promedioGeneral)">{{ promedioGeneral }}</h2>
                            <small class="text-muted">Periodo {{ periodoSeleccionado }}</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Selector de periodo -->
            <div class="row mb-4">
                <div class="col-md-6">
                    <label for="periodo" class="form-label">
                        <i class="bi bi-calendar-range me-1"></i>
                        Seleccionar periodo:
                    </label>
                    <select id="periodo" v-model="periodoSeleccionado" @change="cambiarPeriodo" class="form-select">
                        <option value="1">1° Periodo</option>
                        <option value="2">2° Periodo</option>
                        <option value="3">3° Periodo</option>
                        <option value="4">4° Periodo</option>
                    </select>
                </div>
            </div>

            <!-- Botones de navegación -->
            <div class="mb-4">
                <button 
                    class="btn me-2" 
                    :class="seccionActiva === 'calificaciones' ? 'btn-danger' : 'btn-outline-danger'"
                    @click="seccionActiva = 'calificaciones'">
                    <i class="bi bi-file-earmark-text me-1"></i> Ver Calificaciones
                </button>
                <button 
                    class="btn" 
                    :class="seccionActiva === 'asistencias' ? 'btn-danger' : 'btn-outline-danger'"
                    @click="seccionActiva = 'asistencias'">
                    <i class="bi bi-clock-history me-1"></i> Ver Asistencias
                </button>
            </div>

            <!-- Sección calificaciones -->
            <section v-if="seccionActiva === 'calificaciones'">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h3>
                        <i class="bi bi-trophy me-2"></i>
                        Boletín de Calificaciones - Periodo {{ periodoSeleccionado }}
                    </h3>
                    <button class="btn btn-outline-danger btn-sm" @click="descargarBoletin">
                        <i class="bi bi-download me-1"></i>Descargar PDF
                    </button>
                </div>

                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead class="table-danger">
                            <tr>
                                <th><i class="bi bi-book me-1"></i>Asignatura</th>
                                <th class="text-center"><i class="bi bi-star me-1"></i>Nota</th>
                                <th class="text-center">Estado</th>
                                <th><i class="bi bi-chat-text me-1"></i>Observaciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr v-for="nota in calificacionesPeriodo" :key="nota.materia">
                                <td class="fw-semibold">{{ nota.materia }}</td>
                                <td class="text-center">
                                    <span class="badge fs-6" :class="getNotaClass(nota.nota)">
                                        {{ nota.nota }}
                                    </span>
                                </td>
                                <td class="text-center">
                                    <i :class="getEstadoIcon(nota.nota)" :title="getEstadoTexto(nota.nota)"></i>
                                </td>
                                <td>{{ nota.observaciones || 'Sin observaciones' }}</td>
                            </tr>
                        </tbody>
                        <tfoot class="table-light">
                            <tr>
                                <th>Promedio General</th>
                                <th class="text-center">
                                    <span class="badge fs-6" :class="getNotaClass(promedioGeneral)">
                                        {{ promedioGeneral }}
                                    </span>
                                </th>
                                <th class="text-center">
                                    <i :class="getEstadoIcon(promedioGeneral)"></i>
                                </th>
                                <th>{{ getMensajePromedio(promedioGeneral) }}</th>
                            </tr>
                        </tfoot>
                    </table>
                </div>

                <!-- Gráfica de rendimiento -->
                <div class="row mt-4">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <h5><i class="bi bi-bar-chart me-2"></i>Rendimiento por Materia</h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div v-for="nota in calificacionesPeriodo" :key="nota.materia" class="col-md-6 col-lg-4 mb-3">
                                        <div class="text-center">
                                            <small class="d-block mb-1">{{ nota.materia }}</small>
                                            <div class="progress" style="height: 20px;">
                                                <div 
                                                    class="progress-bar" 
                                                    :class="getProgressClass(nota.nota)"
                                                    :style="{ width: (nota.nota * 20) + '%' }">
                                                    {{ nota.nota }}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Sección asistencias -->
            <section v-if="seccionActiva === 'asistencias'">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h3>
                        <i class="bi bi-calendar-check me-2"></i>
                        Registro de Asistencias - Periodo {{ periodoSeleccionado }}
                    </h3>
                    <div class="text-end">
                        <small class="text-muted">Porcentaje de asistencia: </small>
                        <span class="badge bg-info fs-6">{{ porcentajeAsistencia }}%</span>
                    </div>
                </div>

                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead class="table-secondary">
                            <tr>
                                <th><i class="bi bi-book me-1"></i>Asignatura</th>
                                <th class="text-center"><i class="bi bi-check-circle text-success me-1"></i>Asistencias</th>
                                <th class="text-center"><i class="bi bi-x-circle text-danger me-1"></i>Fallas</th>
                                <th class="text-center"><i class="bi bi-info-circle text-warning me-1"></i>Justificadas</th>
                                <th class="text-center">% Asistencia</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr v-for="asistencia in asistenciasPeriodo" :key="asistencia.materia">
                                <td class="fw-semibold">{{ asistencia.materia }}</td>
                                <td class="text-center text-success">{{ asistencia.asistencias }}</td>
                                <td class="text-center text-danger">{{ asistencia.fallas }}</td>
                                <td class="text-center text-warning">{{ asistencia.justificadas }}</td>
                                <td class="text-center">
                                    <span class="badge" :class="getAsistenciaClass(asistencia.porcentaje)">
                                        {{ asistencia.porcentaje }}%
                                    </span>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Resumen de asistencia -->
                <div class="row mt-4">
                    <div class="col-md-4">
                        <div class="card text-center border-success">
                            <div class="card-body">
                                <i class="bi bi-check-circle-fill text-success fs-1"></i>
                                <h4 class="text-success mt-2">{{ totalAsistencias }}</h4>
                                <p class="card-text">Total Asistencias</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card text-center border-danger">
                            <div class="card-body">
                                <i class="bi bi-x-circle-fill text-danger fs-1"></i>
                                <h4 class="text-danger mt-2">{{ totalFallas }}</h4>
                                <p class="card-text">Total Fallas</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card text-center border-warning">
                            <div class="card-body">
                                <i class="bi bi-info-circle-fill text-warning fs-1"></i>
                                <h4 class="text-warning mt-2">{{ totalJustificadas }}</h4>
                                <p class="card-text">Justificadas</p>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </main>

        <!-- FOOTER -->
        <footer class="bg-danger text-white text-center py-3 mt-auto">
            <p class="mb-0">&copy; 2025 Plataforma Escolar Colombo Holandés. Todos los derechos reservados.</p>
        </footer>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Vue.js -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>

    <!-- Vue.js Script -->
    <script>
        const { createApp } = Vue;

        createApp({
            data() {
                return {
                    loading: true,
                    error: null,
                    usuario: null,
                    grado: "",
                    nombreUsuario: "",
                    periodoSeleccionado: "3",
                    seccionActiva: "calificaciones",
                    calificaciones: {
                        1: [
                            { materia: "Matemáticas", nota: 4.2, observaciones: "Buen desempeño en álgebra" },
                            { materia: "Español", nota: 4.5, observaciones: "Excelente comprensión lectora" },
                            { materia: "Ciencias Naturales", nota: 3.8, observaciones: "Debe repasar el tema de ecosistemas" },
                            { materia: "Sociales", nota: 4.1, observaciones: "Participación activa en clase" },
                            { materia: "Inglés", nota: 4.7, observaciones: "Pronunciación excelente" },
                            { materia: "Educación Física", nota: 4.9, observaciones: "Sobresaliente en deportes" },
                            { materia: "Religión", nota: 4.3, observaciones: "Valores bien aplicados" },
                            { materia: "Informática", nota: 4.6, observaciones: "Domina las herramientas básicas" }
                        ],
                        2: [
                            { materia: "Matemáticas", nota: 4.0, observaciones: "Mejoró en geometría" },
                            { materia: "Español", nota: 4.3, observaciones: "Buena ortografía" },
                            { materia: "Ciencias Naturales", nota: 4.1, observaciones: "Mejor comprensión científica" },
                            { materia: "Sociales", nota: 3.9, observaciones: "Debe estudiar más historia" },
                            { materia: "Inglés", nota: 4.5, observaciones: "Progreso en gramática" },
                            { materia: "Educación Física", nota: 4.8, observaciones: "Excelente condición física" },
                            { materia: "Religión", nota: 4.2, observaciones: "Reflexiones profundas" },
                            { materia: "Informática", nota: 4.4, observaciones: "Creatividad en proyectos" }
                        ],
                        3: [
                            { materia: "Matemáticas", nota: 4.5, observaciones: "Excelente en resolución de problemas" },
                            { materia: "Español", nota: 4.7, observaciones: "Redacción sobresaliente" },
                            { materia: "Ciencias Naturales", nota: 4.2, observaciones: "Buen trabajo en laboratorio" },
                            { materia: "Sociales", nota: 4.3, observaciones: "Análisis crítico desarrollado" },
                            { materia: "Inglés", nota: 4.8, observaciones: "Fluidez notable" },
                            { materia: "Educación Física", nota: 4.6, observaciones: "Liderazgo en equipo" },
                            { materia: "Religión", nota: 4.4, observaciones: "Compromiso social evidente" },
                            { materia: "Informática", nota: 4.9, observaciones: "Programación avanzada" }
                        ],
                        4: [
                            { materia: "Matemáticas", nota: 4.3, observaciones: "Consistencia en cálculos" },
                            { materia: "Español", nota: 4.6, observaciones: "Literatura bien analizada" },
                            { materia: "Ciencias Naturales", nota: 4.4, observaciones: "Método científico aplicado" },
                            { materia: "Sociales", nota: 4.2, observaciones: "Comprensión histórica sólida" },
                            { materia: "Inglés", nota: 4.9, observaciones: "Nivel casi nativo" },
                            { materia: "Educación Física", nota: 4.7, observaciones: "Disciplina deportiva" },
                            { materia: "Religión", nota: 4.5, observaciones: "Valores integrales" },
                            { materia: "Informática", nota: 4.8, observaciones: "Innovación tecnológica" }
                        ]
                    },
                    asistencias: {
                        1: [
                            { materia: "Matemáticas", asistencias: 35, fallas: 3, justificadas: 1, porcentaje: 92 },
                            { materia: "Español", asistencias: 36, fallas: 2, justificadas: 0, porcentaje: 95 },
                            { materia: "Ciencias Naturales", asistencias: 34, fallas: 4, justificadas: 2, porcentaje: 89 },
                            { materia: "Sociales", asistencias: 37, fallas: 1, justificadas: 0, porcentaje: 97 },
                            { materia: "Inglés", asistencias: 35, fallas: 3, justificadas: 1, porcentaje: 92 },
                            { materia: "Educación Física", asistencias: 38, fallas: 0, justificadas: 0, porcentaje: 100 },
                            { materia: "Religión", asistencias: 36, fallas: 2, justificadas: 0, porcentaje: 95 },
                            { materia: "Informática", asistencias: 33, fallas: 5, justificadas: 2, porcentaje: 87 }
                        ],
                        2: [
                            { materia: "Matemáticas", asistencias: 36, fallas: 2, justificadas: 0, porcentaje: 95 },
                            { materia: "Español", asistencias: 35, fallas: 3, justificadas: 1, porcentaje: 92 },
                            { materia: "Ciencias Naturales", asistencias: 37, fallas: 1, justificadas: 0, porcentaje: 97 },
                            { materia: "Sociales", asistencias: 34, fallas: 4, justificadas: 2, porcentaje: 89 },
                            { materia: "Inglés", asistencias: 38, fallas: 0, justificadas: 0, porcentaje: 100 },
                            { materia: "Educación Física", asistencias: 37, fallas: 1, justificadas: 0, porcentaje: 97 },
                            { materia: "Religión", asistencias: 35, fallas: 3, justificadas: 1, porcentaje: 92 },
                            { materia: "Informática", asistencias: 36, fallas: 2, justificadas: 0, porcentaje: 95 }
                        ],
                        3: [
                            { materia: "Matemáticas", asistencias: 38, fallas: 0, justificadas: 0, porcentaje: 100 },
                            { materia: "Español", asistencias: 37, fallas: 1, justificadas: 0, porcentaje: 97 },
                            { materia: "Ciencias Naturales", asistencias: 36, fallas: 2, justificadas: 0, porcentaje: 95 },
                            { materia: "Sociales", asistencias: 35, fallas: 3, justificadas: 1, porcentaje: 92 },
                            { materia: "Inglés", asistencias: 37, fallas: 1, justificadas: 0, porcentaje: 97 },
                            { materia: "Educación Física", asistencias: 38, fallas: 0, justificadas: 0, porcentaje: 100 },
                            { materia: "Religión", asistencias: 36, fallas: 2, justificadas: 0, porcentaje: 95 },
                            { materia: "Informática", asistencias: 37, fallas: 1, justificadas: 0, porcentaje: 97 }
                        ],
                        4: [
                            { materia: "Matemáticas", asistencias: 35, fallas: 3, justificadas: 2, porcentaje: 92 },
                            { materia: "Español", asistencias: 36, fallas: 2, justificadas: 1, porcentaje: 95 },
                            { materia: "Ciencias Naturales", asistencias: 37, fallas: 1, justificadas: 0, porcentaje: 97 },
                            { materia: "Sociales", asistencias: 34, fallas: 4, justificadas: 2, porcentaje: 89 },
                            { materia: "Inglés", asistencias: 38, fallas: 0, justificadas: 0, porcentaje: 100 },
                            { materia: "Educación Física", asistencias: 36, fallas: 2, justificadas: 1, porcentaje: 95 },
                            { materia: "Religión", asistencias: 37, fallas: 1, justificadas: 0, porcentaje: 97 },
                            { materia: "Informática", asistencias: 35, fallas: 3, justificadas: 1, porcentaje: 92 }
                        ]
                    }
                }
            },
            computed: {
                calificacionesPeriodo() {
                    return this.calificaciones[this.periodoSeleccionado] || [];
                },
                asistenciasPeriodo() {
                    return this.asistencias[this.periodoSeleccionado] || [];
                },
                promedioGeneral() {
                    const notas = this.calificacionesPeriodo.map(item => item.nota);
                    if (notas.length === 0) return 0;
                    const suma = notas.reduce((acc, nota) => acc + nota, 0);
                    return (suma / notas.length).toFixed(1);
                },
                porcentajeAsistencia() {
                    const asistencias = this.asistenciasPeriodo;
                    if (asistencias.length === 0) return 0;
                    const totalPorcentajes = asistencias.reduce((acc, item) => acc + item.porcentaje, 0);
                    return Math.round(totalPorcentajes / asistencias.length);
                },
                totalAsistencias() {
                    return this.asistenciasPeriodo.reduce((acc, item) => acc + item.asistencias, 0);
                },
                totalFallas() {
                    return this.asistenciasPeriodo.reduce((acc, item) => acc + item.fallas, 0);
                },
                totalJustificadas() {
                    return this.asistenciasPeriodo.reduce((acc, item) => acc + item.justificadas, 0);
                }
            },
            async mounted() {
                await this.cargarDatosUsuario();
            },
            methods: {
                async cargarDatosUsuario() {
                    try {
                        const usuarioData = localStorage.getItem('usuarioLogueado');
                        
                        if (!usuarioData) {
                            this.error = "No hay sesión activa. Redirigiendo al login...";
                            setTimeout(() => {
                                window.location.href = 'index.html';
                            }, 2000);
                            return;
                        }

                        this.usuario = JSON.parse(usuarioData);
                        
                        if (this.usuario.rol !== 'estudiante') {
                            this.error = "Usuario no válido para ver calificaciones.";
                            return;
                        }

                        this.grado = this.usuario.grado;
                        this.nombreUsuario = this.usuario.usuario;
                        this.loading = false;

                    } catch (err) {
                        this.error = "Error al cargar la información del usuario.";
                        this.loading = false;
                    }
                },
                cambiarPeriodo() {
                    // Aquí puedes agregar lógica para cargar datos del período seleccionado
                    console.log(`Cambiando a período ${this.periodoSeleccionado}`);
                },
                getNotaClass(nota) {
                    if (nota >= 4.5) return 'bg-success';
                    if (nota >= 4.0) return 'bg-primary';
                    if (nota >= 3.5) return 'bg-warning text-dark';
                    return 'bg-danger';
                },
                getPromedioClass(promedio) {
                    if (promedio >= 4.5) return 'text-success';
                    if (promedio >= 4.0) return 'text-primary';
                    if (promedio >= 3.5) return 'text-warning';
                    return 'text-danger';
                },
                getEstadoIcon(nota) {
                    if (nota >= 4.0) return 'bi bi-check-circle-fill text-success';
                    if (nota >= 3.5) return 'bi bi-exclamation-triangle-fill text-warning';
                    return 'bi bi-x-circle-fill text-danger';
                },
                getEstadoTexto(nota) {
                    if (nota >= 4.0) return 'Aprobado';
                    if (nota >= 3.5) return 'En riesgo';
                    return 'Reprobado';
                },
                getProgressClass(nota) {
                    if (nota >= 4.5) return 'bg-success';
                    if (nota >= 4.0) return 'bg-primary';
                    if (nota >= 3.5) return 'bg-warning';
                    return 'bg-danger';
                },
                getAsistenciaClass(porcentaje) {
                    if (porcentaje >= 95) return 'bg-success';
                    if (porcentaje >= 85) return 'bg-primary';
                    if (porcentaje >= 75) return 'bg-warning text-dark';
                    return 'bg-danger';
                },
                getMensajePromedio(promedio) {
                    if (promedio >= 4.5) return 'Rendimiento excelente';
                    if (promedio >= 4.0) return 'Buen rendimiento académico';
                    if (promedio >= 3.5) return 'Rendimiento aceptable, puede mejorar';
                    return 'Necesita apoyo académico';
                },
                descargarBoletin() {
                    alert('Función de descarga de boletín en desarrollo');
                    // Aquí implementarías la lógica para generar y descargar el PDF
                }
            }
        }).mount("#app");
    </script>
</body>
</html>